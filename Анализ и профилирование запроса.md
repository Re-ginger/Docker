# Анализ плана выполнения SQL-запроса

Рассмотрим результаты в трех форматах: TEXT, JSON и TREE:
### Формат TEXT
```sql
mysql> EXPLAIN
    -> SELECT c.customer_id, c.first_name, c.last_name, o.order_id, o.order_date, w.wine_type, v.name AS vineyard_name
    -> FROM Customers c
    -> JOIN Orders o ON c.customer_id = o.customer_id
    -> JOIN WineProduction wp ON o.order_id = wp.production_id
    -> JOIN WineVarieties w ON wp.production_id = w.production_id
    -> JOIN Vineyards v ON wp.vineyard_id = v.vineyard_id
    -> WHERE o.order_date BETWEEN '2024-01-01' AND '2024-12-31'
    -> ORDER BY o.order_date DESC;
+----+-------------+-------+----------------+--------+---------------------+---------------+---------+--------------------------+------+----------+----------------------------------------------+
| id | select_type | table | partitions     | type   | possible_keys       | key           | key_len | ref                      | rows | filtered | Extra                                        |
+----+-------------+-------+----------------+--------+---------------------+---------------+---------+--------------------------+------+----------+----------------------------------------------+
|  1 | SIMPLE      | o     | NULL           | ALL    | PRIMARY,customer_id | NULL          | NULL    | NULL                     |    1 |   100.00 | Using where; Using temporary; Using filesort |
|  1 | SIMPLE      | wp    | p0,p1,p2,p3,p4 | ALL    | NULL                | NULL          | NULL    | NULL                     |    6 |    16.67 | Using where; Using join buffer (hash join)   |
|  1 | SIMPLE      | c     | NULL           | eq_ref | PRIMARY             | PRIMARY       | 4       | VinoState.o.customer_id  |    1 |   100.00 | NULL                                         |
|  1 | SIMPLE      | v     | NULL           | eq_ref | PRIMARY             | PRIMARY       | 4       | VinoState.wp.vineyard_id |    1 |   100.00 | NULL                                         |
|  1 | SIMPLE      | w     | NULL           | ref    | production_id       | production_id | 5       | VinoState.o.order_id     |    1 |   100.00 | NULL                                         |
+----+-------------+-------+----------------+--------+---------------------+---------------+---------+--------------------------+------+----------+----------------------------------------------+
5 rows in set, 1 warning (0.00 sec)
```
### Формат JSON
```sql
mysql> EXPLAIN FORMAT=JSON
SELECT c.customer_id, c.first_name, c.last_name, o.order_id, o.order_date, w.wine_type, v.name AS vineyard_name
FROM Customers c
JOIN Orders o ON c.customer_id = o.customer_id
JOIN WineProduction wp ON o.order_id = wp.production_id
JOIN WineVarieties w ON wp.production_id = w.production_id
JOIN Vineyards v ON wp.vineyard_id = v.vineyard_id
WHERE o.order_date BETWEEN '2024-01-01' AND '2024-12-31'
ORDER BY o.order_date DESC;
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                          |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| {
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "6.50"
    },
    "ordering_operation": {
      "using_temporary_table": true,
      "using_filesort": true,
      "cost_info": {
        "sort_cost": "1.00"
      },
      "nested_loop": [
        {
          "table": {
            "table_name": "o",
            "access_type": "ALL",
            "possible_keys": [
              "PRIMARY",
              "customer_id"
            ],
            "rows_examined_per_scan": 1,
            "rows_produced_per_join": 1,
            "filtered": "100.00",
            "cost_info": {
              "read_cost": "1.00",
              "eval_cost": "0.10",
              "prefix_cost": "1.10",
              "data_read_per_join": "24"
            },
            "used_columns": [
              "order_id",
              "customer_id",
              "order_date"
            ],
            "attached_condition": "((`VinoState`.`o`.`order_date` between '2024-01-01' and '2024-12-31') and (`VinoState`.`o`.`customer_id` is not null))"
          }
        },
        {
          "table": {
            "table_name": "wp",
            "partitions": [
              "p0",
              "p1",
              "p2",
              "p3",
              "p4"
            ],
            "access_type": "ALL",
            "rows_examined_per_scan": 6,
            "rows_produced_per_join": 1,
            "filtered": "16.67",
            "using_join_buffer": "hash join",
            "cost_info": {
              "read_cost": "1.25",
              "eval_cost": "0.10",
              "prefix_cost": "2.95",
              "data_read_per_join": "232"
            },
            "used_columns": [
              "production_id",
              "vineyard_id"
            ],
            "attached_condition": "((`VinoState`.`wp`.`production_id` = `VinoState`.`o`.`order_id`) and (`VinoState`.`wp`.`vineyard_id` is not null))"
          }
        },
        {
          "table": {
            "table_name": "c",
            "access_type": "eq_ref",
            "possible_keys": [
              "PRIMARY"
            ],
            "key": "PRIMARY",
            "used_key_parts": [
              "customer_id"
            ],
            "key_length": "4",
            "ref": [
              "VinoState.o.customer_id"
            ],
            "rows_examined_per_scan": 1,
            "rows_produced_per_join": 1,
            "filtered": "100.00",
            "cost_info": {
              "read_cost": "0.25",
              "eval_cost": "0.10",
              "prefix_cost": "3.30",
              "data_read_per_join": "816"
            },
            "used_columns": [
              "customer_id",
              "first_name",
              "last_name"
            ]
          }
        },
        {
          "table": {
            "table_name": "v",
            "access_type": "eq_ref",
            "possible_keys": [
              "PRIMARY"
            ],
            "key": "PRIMARY",
            "used_key_parts": [
              "vineyard_id"
            ],
            "key_length": "4",
            "ref": [
              "VinoState.wp.vineyard_id"
            ],
            "rows_examined_per_scan": 1,
            "rows_produced_per_join": 1,
            "filtered": "100.00",
            "cost_info": {
              "read_cost": "1.00",
              "eval_cost": "0.10",
              "prefix_cost": "4.40",
              "data_read_per_join": "5K"
            },
            "used_columns": [
              "vineyard_id",
              "name"
            ]
          }
        },
        {
          "table": {
            "table_name": "w",
            "access_type": "ref",
            "possible_keys": [
              "production_id"
            ],
            "key": "production_id",
            "used_key_parts": [
              "production_id"
            ],
            "key_length": "5",
            "ref": [
              "VinoState.o.order_id"
            ],
            "rows_examined_per_scan": 1,
            "rows_produced_per_join": 1,
            "filtered": "100.00",
            "cost_info": {
              "read_cost": "1.00",
              "eval_cost": "0.10",
              "prefix_cost": "5.50",
              "data_read_per_join": "2K"
            },
            "used_columns": [
              "wine_variety_id",
              "production_id",
              "wine_type"
            ]
          }
        }
      ]
    }
  }
} |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set, 1 warning (0.00 sec)
```
### Формат TREE
```sql
mysql> EXPLAIN FORMAT=TREE
SELECT c.customer_id, c.first_name, c.last_name, o.order_id, o.order_date, w.wine_type, v.name AS vineyard_name
FROM Customers c
JOIN Orders o ON c.customer_id = o.customer_id
JOIN WineProduction wp ON o.order_id = wp.production_id
JOIN WineVarieties w ON wp.production_id = w.production_id
JOIN Vineyards v ON wp.vineyard_id = v.vineyard_id
WHERE o.order_date BETWEEN '2024-01-01' AND '2024-12-31'
ORDER BY o.order_date DESC;
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| EXPLAIN                                                                                        |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| -> Sort: o.order_date DESC
    -> Stream results  (cost=4.75 rows=0)
        -> Nested loop inner join  (cost=4.75 rows=0)
            -> Nested loop inner join  (cost=3.73 rows=0)
                -> Nested loop inner join  (cost=2.72 rows=0)
                    -> Inner hash join (wp.production_id = o.order_id)  (cost=2.45 rows=0)
                        -> Filter: (wp.vineyard_id is not null)  (cost=1.35 rows=1)
                            -> Table scan on wp  (cost=1.35 rows=6)
                        -> Hash
                            -> Filter: ((o.order_date between '2024-01-01' and '2024-12-31') and (o.customer_id is not null))  (cost=1.10 rows=1)
                                -> Table scan on o  (cost=1.10 rows=1)
                    -> Single-row index lookup on c using PRIMARY (customer_id=o.customer_id)  (cost=0.35 rows=1)
                -> Single-row index lookup on v using PRIMARY (vineyard_id=wp.vineyard_id)  (cost=1.10 rows=1)
            -> Index lookup on w using production_id (production_id=o.order_id)  (cost=1.10 rows=1)
 |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```

## Проблемные места
1. Полное сканирование таблиц (ALL)

Таблицы Orders и WineProduction используют полный скан, что может замедлить выполнение запроса. Наличие индексов на соответствующих столбцах, например, order_date в таблице Orders, может улучшить производительность.
2. Использование join buffer (hash join)

Таблица WineProduction использует join buffer для соединения, что может указывать на недостаток индексов или большое количество данных для соединения.
3. Сортировка и временные таблицы

Использование временных таблиц и файловой сортировки (Using temporary; Using filesort) может замедлить выполнение запроса. Это связано с сортировкой по o.order_date.

